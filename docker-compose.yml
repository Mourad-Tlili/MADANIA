# docker-compose.yml
# Defines and runs multi-container Docker applications.

version: '3.8' # Specifies the Docker Compose file format version.

services:
  # MySQL Database Service
  mysql_db:
    image: mysql:8.0 # Use an official MySQL image. Version 8.0 is common.
    container_name: mysql_for_user_app # A friendly name for the MySQL container.
    restart: unless-stopped # Policy for restarting the container.
    environment:
      # Environment variables to configure MySQL.
      # IMPORTANT: Remember you used 'test123' for root, 'mourad' for user, 'interview123' for user password, 'user_db' for database.
      MYSQL_ROOT_PASSWORD: test123 # Password for the MySQL root user.
      MYSQL_DATABASE: user_db # Name of the database to be created automatically.
      MYSQL_USER: mourad # Username for your application to connect to the database.
      MYSQL_PASSWORD: interview123 # Password for your application's database user.
    ports:
      # Map port 3306 of the container to port 3306 on the host machine.
      # This allows you to connect to the MySQL instance from your host (e.g., with a GUI tool).
      - "3306:3306"
    volumes:
      # Persist MySQL data using a named volume.
      # This ensures data is not lost when the container is stopped or removed.
      - mysql_app_data:/var/lib/mysql
    networks:
      # Connect this service to a custom network.
      - app-network

  # Your Spring Boot Application Service (running in Tomcat)
  my_app_tomcat_service:
    build:
      context: . # The build context is the current directory (where this docker-compose.yml is).
      dockerfile: Dockerfile # Specifies the Dockerfile (tomcat_dockerfile_phase2) to use for building this service's image.
      args:
        # Pass the WAR file name as a build argument to the Dockerfile.
        # Ensure this matches the actual name of your WAR file generated by Gradle.
        # This should match the ARG WAR_FILE_NAME in your Dockerfile and the output of './gradlew build'.
        WAR_FILE_NAME: mourad-tlili-interview-demo-0.0.1-SNAPSHOT-plain.war
    container_name: spring_boot_on_tomcat # A friendly name for your application container.
    restart: unless-stopped
    depends_on:
      - mysql_db # Ensures mysql_db service is started before this service.
        # Note: This only means the container is started, not that MySQL inside is fully ready.
      # For robust startup, your app might need retry logic or a wait-script in more complex scenarios.
    ports:
      # Map port 8080 of the Tomcat container to port 8080 on the host machine.
      - "8080:8080"
    environment:
      # Spring Boot datasource properties, passed as environment variables to your application.
      # The application running in Tomcat will use these to connect to the 'mysql_db' service.
      # 'mysql_db' is resolvable as a hostname within the 'app-network'.
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql_db:3306/${MYSQL_DATABASE_DEV:-user_db}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME_DEV} # Must match MYSQL_USER for mysql_db service
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD_DEV} # Must match MYSQL_PASSWORD for mysql_db service
      SPRING_JPA_HIBERNATE_DDL_AUTO: update # Or 'validate'/'none' for production. 'update' is convenient for dev.
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQLDialect
      SPRING_JPA_SHOW_SQL: true # For debugging SQL queries
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: true

      # Optional: If your WAR is deployed as ROOT.war (as in Dockerfile Option 3),
      # Spring Boot's context path will be '/'. If deployed with a specific name like 'my-spring-app.war',
      # Tomcat deploys it to /my-spring-app, and Spring Boot usually auto-detects this.
      # Explicitly setting SERVER_SERVLET_CONTEXT_PATH might be needed if auto-detection fails
      # or if you want to ensure a specific path regardless of WAR name in Tomcat.
      # If you copied to ROOT.war, this is usually not needed or should be just "/".
      # SERVER_SERVLET_CONTEXT_PATH: / # If deployed as ROOT.war
      # SERVER_SERVLET_CONTEXT_PATH: /my-spring-app # If deployed as my-spring-app.war

      # Add any other environment variables your Spring Boot application needs.
      # Example: logging levels, custom configurations, etc.
      # LOGGING_LEVEL_ORG_INTERVIEW_DEMO: DEBUG
    networks:
      - app-network

# Named volume for MySQL data persistence.
volumes:
  mysql_app_data:
    driver: local # Specifies the local driver for the volume.

# Custom network to allow services to communicate with each other by service name.
networks:
  app-network:
    driver: bridge # Default network driver.
